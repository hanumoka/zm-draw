# zm-draw 서브에이전트 아키텍처

> 최종 업데이트: 2026-02-08

---

## 개요

zm-draw 프로젝트는 Figma의 기능을 모사하는 에디터를 구현합니다.
Claude Code는 Figma의 세부 기능을 모르므로, 사용자가 스크린샷/GIF를 제공하고
서브에이전트가 이를 분석하여 구현하는 **오케스트레이터 패턴**을 사용합니다.

---

## 서브에이전트 역할 정의

### 1. 중앙 오케스트레이터 (메인 에이전트)

- **역할**: 사용자와 직접 대화, 전체 작업 진두지휘, 서브에이전트 관리
- **담당**:
  - 사용자 요구사항 수신 및 해석
  - 서브에이전트 실행/resume/병렬 관리
  - 서브에이전트 결과를 사용자에게 전달
  - `AskUserQuestion`으로 추가 정보 요청 (서브에이전트는 사용자와 직접 대화 불가)
  - TaskCreate/TaskUpdate로 작업 진행상황 추적

### 2. Figma 기능파악 에이전트

- **타입**: `general-purpose`
- **역할**: 사용자에게 Figma 기능 확인을 위한 요구사항 생성
- **동작**:
  1. 현재 구현 상태와 Figma 기능 갭 분석
  2. 구체적으로 어떤 화면/동작 확인이 필요한지 검토
  3. 사용자에게 요청할 항목 목록 반환 (오케스트레이터가 전달)
- **입력**: 현재 구현 코드, 이전 분석 결과
- **출력**: 스크린샷/GIF 요청 목록 (구체적 동작 시나리오 포함)
- **resume**: 이전 분석 컨텍스트 유지를 위해 resume 활용

### 3. GIF 프레임 분석 에이전트

- **타입**: `general-purpose`
- **역할**: GIF 파일에서 프레임을 추출하고 각 프레임 이미지를 분석
- **동작**:
  1. `scripts/extract-gif-frames.py`로 GIF → PNG 프레임 추출 (Bash)
  2. 추출된 프레임 이미지들을 순서대로 Read (이미지 인식)
  3. 각 프레임의 UI 상태, 애니메이션 변화, 인터랙션 패턴 분석
  4. Figma 동작을 구현 요구사항으로 정리하여 반환
- **입력**: GIF 파일 경로
- **출력**: 프레임별 분석 + 구현 요구사항 정리
- **명령어 예시**:
  ```bash
  python scripts/extract-gif-frames.py <input.gif> --max-frames 20 --output-dir /tmp/frames
  ```

### 4. FE 개발 에이전트

- **타입**: `general-purpose`
- **역할**: 실제 코드 수정 및 구현
- **담당**:
  - 컴포넌트 생성/수정 (Read/Edit/Write)
  - CSS 스타일 작성
  - 빌드 실행 및 에러 수정 (Bash)
  - 타입 정의 추가/수정
- **원칙**:
  - 기존 패턴 준수 (editorStore, plugin registry, `zm-draw-` CSS prefix)
  - `'use client'` 지시문 필수
  - any 사용 금지
- **resume**: 대규모 구현 시 resume으로 점진적 작업

### 5. 재검토 에이전트

- **타입**: `general-purpose`
- **역할**: 작업 단위마다 실수/이슈/문제 자동 재검토
- **검토 항목**:
  - TypeScript 타입 에러 (`pnpm type-check`)
  - 빌드 성공 여부 (`pnpm build`)
  - 기존 기능 깨짐 여부 (regression check)
  - CSS 클래스 네이밍 규칙 (`zm-draw-` 접두사)
  - 코드 스타일/패턴 일관성
  - import 경로 정확성
- **출력**: 문제 목록 + 수정 제안
- **실행 시점**: FE 개발 에이전트 작업 완료 직후

### 6. 문서 자동 갱신 에이전트

- **타입**: `general-purpose`
- **역할**: 작업 내용을 docs에 자동 문서화
- **갱신 대상**:
  - `docs/SESSION.md` — 현재 세션 상태, 마지막 작업, 다음 작업
  - `docs/PROGRESS.md` — 완료 항목 체크, 새 항목 추가
  - `docs/FIGMA-FEATURES.md` — Figma 기능 분석 결과 누적
- **실행 방식**: 백그라운드 실행 (`run_in_background: true`)
- **실행 시점**: 주요 작업 완료 후 자동 실행

---

## 워크플로우

### 기본 작업 흐름

```
사용자 → [오케스트레이터]
              │
              ├─→ [Figma 기능파악 에이전트] → 추가 정보 요청 목록
              │     └─→ 오케스트레이터 → AskUserQuestion → 사용자
              │
              ├─→ [GIF 분석 에이전트] → 프레임별 동작 분석 결과
              │     (사용자가 GIF 제공 시)
              │
              ├─→ [FE 개발 에이전트] → 코드 구현
              │
              ├─→ [재검토 에이전트] → 문제 목록 (개발 완료 후)
              │
              └─→ [문서 갱신 에이전트] → docs 업데이트 (백그라운드)
```

### 병렬 실행 규칙

| 조합 | 병렬 가능 | 비고 |
|------|----------|------|
| Figma 분석 + GIF 분석 | O | 독립적 |
| FE 개발 + 재검토 | X | 개발 완료 후 재검토 |
| 재검토 + 문서 갱신 | O | 독립적 |
| FE 개발 + 문서 갱신 | X | 개발 결과 반영 필요 |

### resume 전략

- **Figma 기능파악 에이전트**: 세션 내 resume 유지 → 이전 분석 컨텍스트 누적
- **FE 개발 에이전트**: 대규모 작업 시 resume → 점진적 구현
- **나머지**: 매 실행 새로 생성 (결과만 반환하면 충분)

---

## 핵심 개선 전략 (CRITICAL)

> 아래 3가지는 오케스트레이터가 **반드시** 준수해야 할 최적화 전략입니다.

### 전략 1: Figma 분석 에이전트 resume 컨텍스트 유지

Figma 기능파악 에이전트는 매번 새로 생성하지 않고, **resume으로 컨텍스트를 유지**합니다.

**이유**: 이전에 파악한 기능을 기억하고 점점 더 정확한 요구사항을 생성하기 위해

**오케스트레이터 프로토콜**:
1. 첫 실행 시 에이전트 ID를 기록 (Task 결과의 `agentId`)
2. 이후 동일 기능 관련 분석 시 `resume: <agentId>`로 호출
3. 세션 내에서 Figma 분석 에이전트는 **단일 인스턴스** 유지
4. 에이전트 ID는 오케스트레이터가 내부적으로 추적 (변수처럼 기억)

```
// 예시 흐름
1회차: Task(Figma분석) → agentId: "abc123" 기록
2회차: Task(Figma분석, resume: "abc123") → 이전 분석 맥락 유지
3회차: Task(Figma분석, resume: "abc123") → 누적 맥락으로 정밀 분석
```

### 전략 2: 재검토 + 문서 갱신 동시 병렬 실행

FE 개발 에이전트 작업 완료 후, **재검토 에이전트**와 **문서 갱신 에이전트**를 동시에 실행합니다.

**이유**: 두 에이전트는 서로 의존성이 없으므로 병렬 실행이 효율적

**오케스트레이터 프로토콜**:
```
FE 개발 에이전트 완료
    │
    ├─→ [재검토 에이전트] (foreground) — 문제 발견 시 즉시 대응
    │
    └─→ [문서 갱신 에이전트] (background) — 결과 대기 불필요
```

- 단일 메시지에 두 Task를 동시에 포함하여 병렬 실행
- 재검토는 foreground (결과 즉시 확인 필요)
- 문서 갱신은 background (`run_in_background: true`)
- 재검토에서 문제 발견 시 → FE 개발 에이전트 resume으로 수정 → 재검토 재실행

### 전략 3: FIGMA-FEATURES.md 세션 간 누적 저장

Figma 기능 분석 결과는 `docs/FIGMA-FEATURES.md`에 누적 저장하여 세션 간에도 유지합니다.

**이유**: 새 세션에서 동일 기능을 다시 분석하는 중복 작업 방지

**오케스트레이터 프로토콜**:
1. 새 세션 시작 시 `docs/FIGMA-FEATURES.md` 읽기 (CLAUDE.md 자동 읽기 목록에 포함)
2. Figma 분석 에이전트 실행 시 기존 분석 결과를 입력으로 제공
3. 분석 완료 후 문서 갱신 에이전트가 결과를 `docs/FIGMA-FEATURES.md`에 누적
4. 이미 분석된 기능은 재분석하지 않고 참조만 함

---

## 오케스트레이터 작업 사이클 체크리스트

매 작업 단위마다 오케스트레이터가 따르는 체크리스트:

```
□ 1. 사용자 요구사항 확인
□ 2. docs/FIGMA-FEATURES.md에서 기존 분석 확인 (중복 방지)
□ 3. 추가 분석 필요 시 → Figma 분석 에이전트 (resume)
□ 4. GIF 제공 시 → GIF 분석 에이전트
□ 5. 구현 요구사항 확정 → FE 개발 에이전트
□ 6. 개발 완료 → 재검토 + 문서 갱신 (병렬)
□ 7. 재검토 문제 → FE 개발 에이전트 resume으로 수정
□ 8. 사용자에게 결과 보고
```

---

## GIF 프레임 추출 도구

### 위치
`scripts/extract-gif-frames.py`

### 사용법

```bash
# 기본 사용 (최대 30프레임 자동 추출)
python scripts/extract-gif-frames.py <input.gif>

# 옵션
python scripts/extract-gif-frames.py <input.gif> \
  --max-frames 20 \
  --skip 3 \
  --output-dir /tmp/gif_frames
```

### 출력
- `frame_000_f0_d100ms.png` — 프레임번호_원본인덱스_딜레이 형식
- 출력 디렉토리: `<입력파일명>_frames/` (기본) 또는 `--output-dir` 지정

### 요구사항
- Python 3.12+ (시스템 설치됨)
- Pillow (시스템 설치됨)

---

## Figma 기능 분석 결과 저장

### 파일: `docs/FIGMA-FEATURES.md`

사용자가 제공한 스크린샷/GIF에서 파악된 Figma 기능을 누적 저장합니다.
세션 간에도 유지되어 중복 분석을 방지합니다.

### 구조

```markdown
# Figma 기능 분석

## Shapes 패널
- [분석 내용]

## 커넥터
- [분석 내용]

## (추가 기능별 섹션)
```

---

## 제약사항

1. **서브에이전트는 사용자와 직접 대화 불가** — 오케스트레이터만 AskUserQuestion 사용
2. **서브에이전트는 단일 결과 반환** — 작업 완료 후 하나의 메시지로 결과 반환
3. **서브에이전트 간 직접 통신 불가** — 오케스트레이터가 중계
4. **이미지 인식은 Read 도구** — 서브에이전트 내부에서 Read로 PNG/JPG 이미지 인식 가능
5. **GIF 직접 인식 불가** — 반드시 프레임 추출 후 PNG로 분석

---

*최종 업데이트: 2026-02-08*
